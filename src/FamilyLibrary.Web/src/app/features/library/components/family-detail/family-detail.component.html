<div class="p-5 space-y-5">
  @if (loading()) {
    <div class="space-y-3">
      <div class="h-5 bg-gray-200 rounded animate-pulse w-48"></div>
      <div class="h-3 bg-gray-200 rounded animate-pulse w-32"></div>
    </div>
  } @else if (error()) {
    <div class="flex items-center gap-2.5 p-4 rounded-lg bg-red-50 border border-red-200">
      <i class="pi pi-exclamation-triangle text-red-500"></i>
      <span class="text-sm text-red-700">{{ error() }}</span>
    </div>
  } @else if (family(); as f) {
    <div class="flex items-center gap-3">
      <button
        type="button"
        class="w-7 h-7 flex items-center justify-center rounded-md hover:bg-gray-100 text-[var(--text-muted)] transition-colors"
        routerLink="/library"
        aria-label="Back to library"
      >
        <i class="pi pi-arrow-left text-sm"></i>
      </button>
      <div class="flex-1 min-w-0">
        <h1 class="text-lg font-semibold text-[var(--text-primary)] truncate">{{ f.familyName }}</h1>
        <div class="flex items-center gap-2 mt-0.5">
          <span class="text-xs text-[var(--text-secondary)]">{{ f.roleName }}</span>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[0.625rem] font-medium bg-[var(--accent-soft)] text-[var(--accent)]">
            v{{ f.currentVersion }}
          </span>
        </div>
      </div>
      <p-button
        label="Load to Project"
        icon="pi pi-download"
        severity="primary"
        size="small"
        (onClick)="loadFamilyToProject()"
      />
    </div>

    <div class="flex flex-wrap items-center gap-3 text-xs text-[var(--text-secondary)]">
      @if (f.type) {
        <span class="inline-flex items-center px-2 py-0.5 rounded-full font-medium"
          [class]="f.type === 'Loadable' ? 'bg-blue-50 text-blue-600' : 'bg-amber-50 text-amber-600'"
        >{{ f.type }}</span>
      }
      @if (f.categoryName) {
        <span class="flex items-center gap-1">
          <i class="pi pi-sitemap text-[0.65rem]"></i>
          {{ f.categoryName }}
        </span>
      }
      @if (f.tags && f.tags.length > 0) {
        <span class="flex items-center gap-1">
          @for (tag of f.tags; track tag.id) {
            <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-gray-100 text-[var(--text-muted)] text-[0.6875rem]">{{ tag.name }}</span>
          }
        </span>
      }
      @if (f.description) {
        <span class="text-[var(--text-muted)]">{{ f.description }}</span>
      }
    </div>

    <p-tabs [(value)]="activeTab">
      <p-tablist>
        <p-tab value="overview">Versions</p-tab>
        @if (hasTypeCatalog()) {
          <p-tab value="type-catalog">Type Catalog</p-tab>
        }
        <p-tab value="changelog">Changelog</p-tab>
      </p-tablist>

      <p-tabpanels>
        <p-tabpanel value="overview">
          <div class="pt-3">
            <p-table
              [value]="f.versions"
              dataKey="id"
              [rowHover]="true"
              [showGridlines]="false"
              tableStyleClass="w-full"
            >
              <ng-template #header>
                <tr>
                  <th>Version</th>
                  <th>Message</th>
                  <th>Published</th>
                  <th>File</th>
                  <th class="text-right">Actions</th>
                </tr>
              </ng-template>
              <ng-template #body let-version>
                <tr>
                  <td>
                    <p-tag [value]="'v' + version.version" [severity]="isCurrentVersion(version) ? 'success' : 'secondary'" />
                  </td>
                  <td class="text-[var(--text-secondary)]">{{ version.commitMessage ?? '—' }}</td>
                  <td class="text-[var(--text-secondary)]">{{ version.publishedAt | date:'mediumDate' }}</td>
                  <td class="text-[var(--text-muted)]">{{ version.originalFileName }}</td>
                  <td class="text-right">
                    <p-button
                      icon="pi pi-download"
                      [rounded]="true"
                      [text]="true"
                      severity="secondary"
                      size="small"
                      pTooltip="Download"
                      (onClick)="downloadVersion(version)"
                    />
                  </td>
                </tr>
              </ng-template>
              <ng-template #emptymessage>
                <tr>
                  <td colspan="5" class="text-center text-[var(--text-muted)] py-8">No versions</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </p-tabpanel>

        @if (hasTypeCatalog()) {
          <p-tabpanel value="type-catalog">
            <div class="pt-3 space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-xs text-[var(--text-muted)]">
                  {{ selectedTypesCount() }} of {{ typeCatalogTypes().length }} selected
                </span>
                <div class="flex items-center gap-2">
                  <p-button
                    [label]="selectedTypesCount() === typeCatalogTypes().length ? 'Deselect All' : 'Select All'"
                    [text]="true"
                    severity="secondary"
                    size="small"
                    (onClick)="toggleAllTypes()"
                  />
                  <p-button
                    label="Load Selected"
                    icon="pi pi-download"
                    severity="primary"
                    size="small"
                    [disabled]="selectedTypesCount() === 0"
                    (onClick)="loadSelectedTypes()"
                  />
                </div>
              </div>

              <p-table
                [value]="typeCatalogTypes()"
                dataKey="TypeName"
                [rowHover]="true"
                [showGridlines]="false"
                tableStyleClass="w-full"
              >
                <ng-template #header>
                  <tr>
                    <th class="w-10"></th>
                    @for (field of typeCatalogFields(); track field) {
                      <th>{{ field }}</th>
                    }
                  </tr>
                </ng-template>
                <ng-template #body let-type let-rowIndex="rowIndex">
                  <tr
                    class="cursor-pointer"
                    [class.bg-[var(--accent-soft)]]="isTypeSelected(rowIndex)"
                    (click)="toggleTypeSelection(rowIndex)"
                  >
                    <td>
                      <p-checkbox
                        [binary]="true"
                        [ngModel]="isTypeSelected(rowIndex)"
                        (ngModelChange)="toggleTypeSelection(rowIndex)"
                      />
                    </td>
                    @for (field of typeCatalogFields(); track field) {
                      <td class="text-[var(--text-secondary)]">{{ type.values[field] ?? '—' }}</td>
                    }
                  </tr>
                </ng-template>
                <ng-template #emptymessage>
                  <tr>
                    <td class="text-center text-[var(--text-muted)] py-8" [attr.colspan]="typeCatalogFields().length + 1">
                      No types available
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </p-tabpanel>
        }

        <p-tabpanel value="changelog">
          <div class="pt-3">
            <app-changelog [familyId]="familyId()" />
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  }
</div>
