<div class="space-y-6">
  @if (loading()) {
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="animate-pulse space-y-4">
        <div class="h-8 bg-gray-200 rounded w-1/3"></div>
        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
        <div class="h-4 bg-gray-200 rounded w-1/4"></div>
      </div>
    </div>
  } @else if (error()) {
    <div class="bg-white rounded-lg shadow-sm border border-red-200 p-6">
      <div class="flex items-center gap-3 text-red-600">
        <i class="pi pi-exclamation-triangle text-2xl"></i>
        <div>
          <p class="font-medium">Error loading family</p>
          <p class="text-sm text-red-500">{{ error() }}</p>
        </div>
      </div>
    </div>
  } @else if (family(); as familyData) {
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ familyData.familyName }}</h1>
        <p class="text-sm text-gray-500 mt-1">{{ familyData.roleName }}</p>
      </div>
      <div class="flex items-center gap-2">
        <p-tag [value]="'v' + familyData.currentVersion" severity="info" />
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <p-button
        label="Load to Project"
        icon="pi pi-download"
        severity="primary"
        (onClick)="loadFamilyToProject()"
      />
    </div>

    <!-- Tabs for Version History, Type Catalog, and Changelog -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
      <p-tabs [(value)]="activeTab">
        <p-tablist>
          <p-tab value="overview">Overview</p-tab>
          @if (hasTypeCatalog()) {
            <p-tab value="type-catalog">Type Catalog</p-tab>
          }
          <p-tab value="changelog">Changelog</p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- Overview Tab: Version History -->
          <p-tabpanel value="overview">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">Version History</h2>
              <p-table
                [value]="familyData.versions"
                dataKey="id"
                [rowHover]="true"
                [showGridlines]="false"
                [stripedRows]="true"
                tableStyleClass="w-full"
              >
                <ng-template #header>
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Version</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Message</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Published</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">File</th>
                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Actions</th>
                  </tr>
                </ng-template>
                <ng-template #body let-version>
                  <tr class="border-t border-gray-100">
                    <td class="px-4 py-3">
                      <p-tag [value]="'v' + version.version" [severity]="isCurrentVersion(version) ? 'success' : 'secondary'" />
                    </td>
                    <td class="px-4 py-3 text-gray-600">
                      {{ version.commitMessage ?? '-' }}
                    </td>
                    <td class="px-4 py-3 text-gray-600">
                      {{ version.publishedAt | date:'mediumDate' }}
                    </td>
                    <td class="px-4 py-3 text-gray-600">
                      {{ version.originalFileName }}
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center justify-end gap-2">
                        <p-button
                          icon="pi pi-download"
                          [rounded]="true"
                          [text]="true"
                          severity="secondary"
                          pTooltip="Download"
                          (onClick)="downloadVersion(version)"
                        />
                      </div>
                    </td>
                  </tr>
                </ng-template>
                <ng-template #emptymessage>
                  <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                      No version history available
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </p-tabpanel>

          <!-- Type Catalog Tab -->
          @if (hasTypeCatalog()) {
            <p-tabpanel value="type-catalog">
              <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-900">Type Catalog</h2>
                  <p-button
                    label="Load Selected"
                    icon="pi pi-download"
                    severity="success"
                    [disabled]="selectedTypesCount() === 0"
                    (onClick)="loadSelectedTypes()"
                  />
                </div>

                <div class="p-4 mb-4 border border-gray-200 rounded-lg bg-gray-50 flex items-center justify-between">
                  <span class="text-sm text-gray-600">
                    {{ selectedTypesCount() }} of {{ typeCatalogTypes().length }} types selected
                  </span>
                  <p-button
                    [label]="selectedTypesCount() === typeCatalogTypes().length ? 'Deselect All' : 'Select All'"
                    [text]="true"
                    severity="secondary"
                    (onClick)="toggleAllTypes()"
                  />
                </div>

                <p-table
                  [value]="typeCatalogTypes()"
                  dataKey="TypeName"
                  [rowHover]="true"
                  [showGridlines]="false"
                  [stripedRows]="true"
                  tableStyleClass="w-full"
                >
                  <ng-template #header>
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-12">
                        <span class="sr-only">Select</span>
                      </th>
                      @for (field of typeCatalogFields(); track field) {
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ field }}</th>
                      }
                    </tr>
                  </ng-template>
                  <ng-template #body let-type let-rowIndex="rowIndex">
                    <tr
                      class="border-t border-gray-100 cursor-pointer"
                      [class.bg-blue-50]="isTypeSelected(rowIndex)"
                      (click)="toggleTypeSelection(rowIndex)"
                    >
                      <td class="px-4 py-3">
                        <p-checkbox
                          [binary]="true"
                          [ngModel]="isTypeSelected(rowIndex)"
                          (ngModelChange)="toggleTypeSelection(rowIndex)"
                          [aria-label]="'Select type ' + (type.values['TypeName'] ?? rowIndex)"
                        />
                      </td>
                      @for (field of typeCatalogFields(); track field) {
                        <td class="px-4 py-3 text-gray-600">
                          {{ type.values[field] ?? '-' }}
                        </td>
                      }
                    </tr>
                  </ng-template>
                  <ng-template #emptymessage>
                    <tr>
                      <td class="px-4 py-8 text-center text-gray-500" [attr.colspan]="typeCatalogFields().length + 1">
                        No type catalog available
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </p-tabpanel>
          }

          <!-- Changelog Tab -->
          <p-tabpanel value="changelog">
            <div class="p-4">
              <app-changelog [familyId]="familyId()" />
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  }
</div>
